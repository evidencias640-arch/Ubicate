<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Automático de Captura y Exportación (OCR)</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            padding: 10px;
            margin: 0;
            text-align: center;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        
        .btn-group { margin-bottom: 20px; }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin: 5px;
        }
        #cameraButton { background-color: #2980b9; color: white; }
        #cameraButton:hover { background-color: #3498db; }
        
        #exportButton { background-color: #27ae60; color: white; }
        #exportButton:hover { background-color: #2ecc71; }
        
        #clearButton { background-color: #e74c3c; color: white; }
        #clearButton:hover { background-color: #c0392b; }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            width: 95%;
            max-width: 450px;
            font-size: 0.9em;
        }
        .error { background-color: #e74c3c; color: white; }
        .success { background-color: #2ecc71; color: white; }
        .info { background-color: #3498db; color: white; }
        .warning { background-color: #f1c40f; color: #333; }
        
        #video-container {
            position: relative;
            width: 95%;
            max-width: 450px;
            padding-top: 70%; 
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            border: 5px solid #2980b9; 
        }
        #canvas { display: none; } 

        #result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 450px;
            text-align: left;
        }
        .data-item { margin-bottom: 8px; font-size: 0.95em; }
        
        #dataList {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            max-height: 200px;
            overflow-y: auto;
            width: 95%;
            max-width: 450px;
            text-align: left;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>Lector Automático de Documentos Colombianos</h1>
    
    <div id="status-message" class="message info">Cargando Tesseract.js...</div>

    <div class="btn-group">
        <button id="cameraButton" disabled>Iniciar Captura Automática</button>
        <button id="exportButton" disabled>Descargar Excel (CSV)</button>
        <button id="clearButton">Limpiar Datos Locales</button>
    </div>

    <div id="video-container" class="hidden">
        <video id="video" playsinline></video>
    </div>
    
    <canvas id="canvas"></canvas>

    <div id="result-box" class="hidden">
        <h2>Último Escaneo:</h2>
        <div class="data-item">
            <strong>Estado:</strong> <span id="scanStatus"></span>
        </div>
        <div class="data-item">
            <strong>Tipo de Documento:</strong> <span id="docTypeSpan">N/A</span>
        </div>
        <div class="data-item">
            <strong>Número de Documento:</strong> <span id="docNumberSpan">N/A</span>
        </div>
        <div class="data-item">
            <strong>Nombre Completo:</strong> <span id="fullNameSpan">N/A</span>
        </div>
    </div>
    
    <div id="dataList">
        <h3>Documentos Capturados (<span id="countSpan">0</span>):</h3>
        <ul id="capturedList">
            <li>(Datos aparecerán aquí)</li>
        </ul>
    </div>


    <script src='https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js'></script>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraButton = document.getElementById('cameraButton');
        const exportButton = document.getElementById('exportButton');
        const clearButton = document.getElementById('clearButton');
        const videoContainer = document.getElementById('video-container');
        const statusMessage = document.getElementById('status-message');
        const resultBox = document.getElementById('result-box');
        const capturedList = document.getElementById('capturedList');
        const countSpan = document.getElementById('countSpan');
        
        const scanStatusSpan = document.getElementById('scanStatus');
        const docTypeSpan = document.getElementById('docTypeSpan');
        const docNumberSpan = document.getElementById('docNumberSpan');
        const fullNameSpan = document.getElementById('fullNameSpan');

        // State Variables
        let currentStream = null;
        let isCameraActive = false;
        let worker = null;
        let documentsData = [];
        let autoCaptureTimer = null;

        const STORAGE_KEY = 'colombian_documents_data';
        const CAPTURE_DELAY_MS = 3000; // 3 segundos para captura automática

        // --- Utilidades de Persistencia y Visualización ---

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            documentsData = data ? JSON.parse(data) : [];
            updateUIList();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(documentsData));
            updateUIList();
        }
        
        function updateUIList() {
            capturedList.innerHTML = '';
            countSpan.textContent = documentsData.length;
            
            if (documentsData.length === 0) {
                 capturedList.innerHTML = '<li>Aún no hay documentos capturados.</li>';
                 exportButton.disabled = true;
                 return;
            }
            
            // Mostrar los últimos 10 documentos capturados, del más reciente al más antiguo
            documentsData.slice().reverse().slice(0, 10).forEach(doc => { 
                const li = document.createElement('li');
                li.textContent = `${doc.documentNumber} - ${doc.fullName} (${doc.type})`;
                capturedList.appendChild(li);
            });
            exportButton.disabled = false;
        }

        function setStatus(text, type = 'info') {
            statusMessage.textContent = text;
            statusMessage.className = `message ${type}`;
        }

        function toggleCameraView(show) {
            videoContainer.classList.toggle('hidden', !show);
            resultBox.classList.add('hidden');
            cameraButton.textContent = show ? 'Detener Captura' : 'Iniciar Captura Automática';
        }

        // --- Lógica de la Cámara y Captura Automática ---

        function stopCameraStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (video.srcObject) {
                video.srcObject = null;
            }
        }
        
        function stopAutoCapture() {
            if (autoCaptureTimer) {
                clearTimeout(autoCaptureTimer);
                autoCaptureTimer = null;
            }
            stopCameraStream();
            isCameraActive = false;
            toggleCameraView(false);
            // El estado se actualiza en la función que llama a stopAutoCapture
        }

        async function startCameraAndAutoCapture() {
            if (isCameraActive) {
                setStatus('Captura automática detenida por el usuario.', 'info');
                stopAutoCapture();
                return;
            }

            setStatus('Solicitando permiso de cámara...', 'info');
            
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { ideal: 'environment' } } 
                });
                
                video.srcObject = currentStream;
                await video.play();

                isCameraActive = true;
                toggleCameraView(true);
                
                // Iniciar la captura automática después del delay
                setStatus(`Cámara activa. Captura automática en ${CAPTURE_DELAY_MS / 1000}s...`, 'warning');
                autoCaptureTimer = setTimeout(captureAndProcess, CAPTURE_DELAY_MS);

            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                let message = '❌ Error al iniciar la cámara. ';
                if (error.name === 'NotAllowedError') {
                    message += '⚠️ Permiso denegado. Habilita el acceso a la cámara en tu navegador.';
                } else if (error.name === 'NotFoundError') {
                    message += '⚠️ No se encontró cámara.';
                }
                setStatus(message, 'error');
                stopAutoCapture();
            }
        }

        function captureAndProcess() {
             if (!isCameraActive) return;
             
             // 1. Dibujar el frame actual en el canvas
             canvas.width = video.videoWidth;
             canvas.height = video.videoHeight;
             const ctx = canvas.getContext('2d');
             ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

             // 2. Detener la cámara y el timer
             stopAutoCapture(); 
             setStatus('Documento capturado. Iniciando OCR y detección de duplicados...', 'info');

             // 3. Ejecutar OCR y guardar
             runOCRAndSave(canvas);
        }

        // --- Lógica de OCR, Duplicados y Guardado ---

        async function runOCRAndSave(image) {
            resultBox.classList.remove('hidden');
            scanStatusSpan.textContent = 'Procesando...';
            
            try {
                // OCR: Reconocimiento de caracteres en español (spa)
                const { data: { text } } = await worker.recognize(image);
                
                // Extraer los datos estructurados
                const extracted = extractDocumentData(text);
                
                // Limpiar el número de documento para comparación de duplicados
                const uniqueId = extracted.numeroDocumento.replace(/[^0-9]/g, ''); 
                
                docTypeSpan.textContent = extracted.tipoDocumento;
                docNumberSpan.textContent = extracted.numeroDocumento;
                fullNameSpan.textContent = extracted.nombreCompleto;
                
                // 4. Detección de Duplicados y Validación
                const isDuplicate = documentsData.some(doc => doc.uniqueId === uniqueId);
                
                if (!uniqueId || uniqueId === 'N/A' || extracted.nombreCompleto === 'N/A') {
                    scanStatusSpan.textContent = 'FALLIDO';
                    setStatus('❌ No se pudo extraer el Número y/o Nombre. Intenta de nuevo.', 'error');
                } else if (isDuplicate) {
                    scanStatusSpan.textContent = 'DUPLICADO';
                    setStatus(`⚠️ Documento ${uniqueId} ya ha sido escaneado. No guardado.`, 'warning');
                } else {
                    // 5. Guardar el nuevo documento
                    const newDoc = {
                        uniqueId: uniqueId, 
                        documentNumber: extracted.numeroDocumento,
                        type: extracted.tipoDocumento,
                        fullName: extracted.nombreCompleto,
                        scanDate: new Date().toISOString()
                    };
                    documentsData.push(newDoc);
                    saveData();
                    
                    scanStatusSpan.textContent = 'GUARDADO';
                    setStatus(`✅ Documento ${uniqueId} guardado con éxito. Total: ${documentsData.length}.`, 'success');
                }
                
            } catch (error) {
                console.error('Error durante el OCR:', error);
                scanStatusSpan.textContent = 'FALLIDO';
                setStatus('❌ Error grave de OCR. Revisa la consola.', 'error');
            }
        }


        // --- Lógica de Extracción Mejorada (Parsing) ---

        function extractDocumentData(ocrText) {
            const defaultResult = {
                tipoDocumento: 'N/A',
                numeroDocumento: 'N/A',
                nombreCompleto: 'N/A'
            };

            const normalizedText = ocrText.toUpperCase().replace(/\s+/g, ' ').trim();
            const lines = ocrText.toUpperCase().split('\n').map(line => line.trim()).filter(line => line.length > 3);

            let docType = 'N/A';
            let docNumber = 'N/A';
            let fullName = 'N/A';
            
            // Expresiones Regulares para identificación de campos
            const idRegex = /(?:NUIP|CÉDULA|CEDULA|NÚMERO|NUMERO|NO\.)\s*[\.:]*\s*(\d{1,3}[\.\s]\d{3}[\.\s]\d{3}[\.\s]\d{3}|\d{7,15})/i;
            const migraRegex = /(?:MIGRACIÓN|PERMISO\sPOR\sPROTECCIÓN\sTEMPORAL|PEP|PPT|DNI\/NIF|NO\.)\s*(\d{7,15})/i; 

            // 1. Búsqueda de Número y Tipo (más importante para la clave)
            for (const line of lines) {
                let match;
                
                if (match = line.match(migraRegex)) {
                    docNumber = match[1];
                    docType = 'MIGRA/PPT/PEP';
                    break;
                }
                if (match = line.match(idRegex)) {
                    docNumber = match[1];
                    docType = line.includes('TARJETA') || line.includes('TI') ? 'TI' : 'CC';
                    break;
                }
            }
            
            // 2. Búsqueda de Nombre y Apellidos
            let apellidoText = '';
            let nombreText = '';

            for (const line of lines) {
                if (line.includes('APELLIDO')) {
                    apellidoText = line;
                }
                if (line.includes('NOMBRE') && !line.includes('COMPLETO')) { // Evitar NOMBRE COMPLETO si no es el valor
                    nombreText = line;
                }
            }
            
            if (apellidoText || nombreText) {
                // Limpiar la línea y dejar solo los nombres/apellidos
                const cleanApellido = apellidoText.replace(/(?:APELLIDOS|APELLIDO)\s*[\.:]*\s*/i, '').trim();
                const cleanNombre = nombreText.replace(/(?:NOMBRES|NOMBRE|NOMBRE\sCOMPLETO)\s*[\.:]*\s*/i, '').trim();
                
                // Si encontramos ambas etiquetas, las juntamos
                if (cleanApellido && cleanNombre) {
                    fullName = `${cleanNombre} ${cleanApellido}`.trim();
                } else {
                    // Si solo hay una línea, podría ser el nombre completo (ej. documentos antiguos)
                    fullName = cleanNombre || cleanApellido || 'N/A';
                }
            }

            // Resultado final
            return {
                tipoDocumento: docType,
                // Limpiar el número de documento de puntos y espacios antes de devolverlo
                numeroDocumento: docNumber.replace(/[\.\s]/g, '') || defaultResult.numeroDocumento, 
                nombreCompleto: fullName || defaultResult.nombreCompleto
            };
        }


        // --- Exportación a CSV (Excel) ---

        function exportToCSV() {
            if (documentsData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            
            // 1. Crear el encabezado CSV
            const headers = ['TIPO_DOCUMENTO', 'NUMERO_DOCUMENTO', 'NOMBRE_COMPLETO', 'FECHA_CAPTURA'];
            let csvContent = headers.join(',') + '\n';

            // 2. Llenar las filas
            documentsData.forEach(doc => {
                const row = [
                    `"${doc.type}"`,
                    `"${doc.documentNumber}"`,
                    `"${doc.fullName.replace(/"/g, '""')}"`, 
                    `"${new Date(doc.scanDate).toLocaleString('es-CO')}"`
                ];
                csvContent += row.join(',') + '\n';
            });

            // 3. Crear el BLOB y el enlace de descarga
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (navigator.msSaveBlob) { 
                navigator.msSaveBlob(blob, 'Documentos_Escaneados.csv');
            } else {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "Documentos_Escaneados.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            setStatus(`Exportación a CSV exitosa.`, 'success');
        }

        // --- Inicialización y Eventos ---
        
        async function initializeTesseractWorker() {
            setStatus('Cargando núcleo de OCR (Tesseract.js)...', 'info');
             try {
                worker = await Tesseract.createWorker('spa'); 
                setStatus('Tesseract Worker cargado. Listo para iniciar.', 'success');
                cameraButton.disabled = false;
                loadData(); 
            } catch (error) {
                setStatus('❌ Error: Falló la inicialización de Tesseract. Revisa la conexión a internet.', 'error');
                console.error(error);
                cameraButton.disabled = true;
            }
        }
        
        cameraButton.addEventListener('click', startCameraAndAutoCapture);
        exportButton.addEventListener('click', exportToCSV);
        clearButton.addEventListener('click', () => {
             if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos escaneados? Esta acción es irreversible.')) {
                 localStorage.removeItem(STORAGE_KEY);
                 documentsData = [];
                 updateUIList();
                 setStatus('Datos locales eliminados con éxito.', 'info');
             }
        });

        document.addEventListener('DOMContentLoaded', initializeTesseractWorker);
    </script>
</body>
</html>
