<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tracking Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
    #app { max-width:600px; margin:auto; padding:20px; }
    .panel { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    input, button, select { width:100%; padding:10px; margin-top:8px; border-radius:6px; border:1px solid #ccc; }
    #map { height:60vh; border-radius:10px; margin-top:10px; }
  </style>
</head>
<body>
<div id="app">
  <div class="panel" id="loginPanel">
    <h3>Iniciar sesiÃ³n</h3>
    <input type="email" id="email" placeholder="Correo" />
    <input type="password" id="password" placeholder="ContraseÃ±a" />
    <select id="mode">
      <option value="tracker">Rastreador</option>
      <option value="device">Dispositivo</option>
    </select>
    <button id="btnLogin">Entrar</button>
    <div id="loginMsg"></div>
  </div>

  <div class="panel" id="trackerPanel" style="display:none;">
    <h3>Modo Rastreador</h3>
    <input id="trackCode" placeholder="CÃ³digo del dispositivo"/>
    <button id="btnStartTrack">Comenzar Seguimiento</button>
    <button id="btnStopTrack">Detener</button>
    <div id="statusTrack"></div>
    <div id="map"></div>
  </div>

  <div class="panel" id="devicePanel" style="display:none;">
    <h3>Modo Dispositivo</h3>
    <input id="deviceCode" placeholder="CÃ³digo del dispositivo"/>
    <button id="btnStartSend">Comenzar EnvÃ­o</button>
    <button id="btnStopSend">Detener</button>
    <div id="statusDevice"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw2XgCXoxi0KkvjKRbuf7B0WXSedkPaEOYJw-roLsNWiJryWKWAAP_bzLAxRL57eX--fg/exec'; // âœ… Web App pÃºblica

// ======================= LOGIN =======================
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const mode = document.getElementById('mode').value;
  const msg = document.getElementById('loginMsg');

  if(!email || !password){
    msg.innerText = 'âš ï¸ Completa los campos.';
    return;
  }

  msg.innerText = 'ðŸ” Autenticando...';
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action:'login', email, password })
    });
    const data = await res.json();

    if(data.success){
      msg.innerText = 'âœ… Bienvenido';
      document.getElementById('loginPanel').style.display='none';
      if(mode === 'tracker'){
        document.getElementById('trackerPanel').style.display='block';
      } else {
        document.getElementById('devicePanel').style.display='block';
      }
      window.localStorage.setItem('codigo_x', data.codigo_x);
    } else {
      msg.innerText = 'âŒ ' + (data.message || 'Credenciales incorrectas');
    }
  } catch(err){
    msg.innerText = 'ðŸš« Error de conexiÃ³n';
    console.error(err);
  }
});

// ======================= MAPA (TRACKER) =======================
let map, marker, trackTimer;
function initMap(){
  if(map) return;
  map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

document.getElementById('btnStartTrack').addEventListener('click', ()=>{
  initMap();
  const code = document.getElementById('trackCode').value.trim();
  if(!code){ alert('CÃ³digo requerido'); return; }

  document.getElementById('statusTrack').innerText = 'ðŸ” Iniciando seguimiento...';

  const fetchLocation = async ()=>{
    try {
      const res = await fetch(`${API_URL}?codigo_x=${code}`);
      const data = await res.json();

      if(data.lat && data.lon){
        const { lat, lon, ultima_actualizacion } = data;
        if(!marker) marker = L.marker([lat, lon]).addTo(map);
        else marker.setLatLng([lat, lon]);
        map.setView([lat, lon], 15);
        document.getElementById('statusTrack').innerText = 
          `ðŸ“ ${lat.toFixed(5)}, ${lon.toFixed(5)} (${ultima_actualizacion})`;
      } else {
        document.getElementById('statusTrack').innerText = 'âš ï¸ No se encontraron coordenadas.';
      }
    } catch(err){
      console.warn('Error obteniendo ubicaciÃ³n:', err);
      document.getElementById('statusTrack').innerText = 'âš ï¸ Error de conexiÃ³n.';
    }
  };

  fetchLocation(); // primera llamada
  trackTimer = setInterval(fetchLocation, 10000); // cada 10 seg
});

document.getElementById('btnStopTrack').addEventListener('click', ()=>{
  if(trackTimer) clearInterval(trackTimer);
  document.getElementById('statusTrack').innerText = 'ðŸ›‘ Seguimiento detenido.';
});

// ======================= MODO DISPOSITIVO =======================
let watchId = null;

document.getElementById('btnStartSend').addEventListener('click', ()=>{
  const code = document.getElementById('deviceCode').value.trim();
  if(!code){ alert('CÃ³digo requerido'); return; }

  document.getElementById('statusDevice').innerText = 'ðŸ“¡ Activando GPS...';

  if(!navigator.geolocation){
    alert('Tu navegador no soporta geolocalizaciÃ³n.');
    return;
  }

  // watchPosition actualiza en tiempo real y consume menos
  watchId = navigator.geolocation.watchPosition(async pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action:'updateLocation', codigo_x: code, lat, lon })
      });
      const data = await res.json();
      if(data.success){
        document.getElementById('statusDevice').innerText = 
          `ðŸ“¤ ${lat.toFixed(5)}, ${lon.toFixed(5)} â€” ${new Date().toLocaleTimeString()}`;
      } else {
        document.getElementById('statusDevice').innerText = 'âš ï¸ Error al enviar datos.';
      }
    } catch(err){
      console.error('Error al actualizar ubicaciÃ³n:', err);
      document.getElementById('statusDevice').innerText = 'ðŸš« ConexiÃ³n fallida.';
    }
  }, 
  err=>{
    console.warn('Error de geolocalizaciÃ³n:', err);
    document.getElementById('statusDevice').innerText = 'âš ï¸ Error obteniendo ubicaciÃ³n.';
  },
  { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
});

document.getElementById('btnStopSend').addEventListener('click', ()=>{
  if(watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  document.getElementById('statusDevice').innerText = 'ðŸ›‘ EnvÃ­o detenido.';
});
</script>

</body>
</html>
