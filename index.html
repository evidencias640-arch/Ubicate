<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Documentos (OCR) - Colombia</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            padding: 10px;
            margin: 0;
            text-align: center;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        
        button {
            padding: 12px 25px;
            background-color: #27ae60; /* Verde para OCR/Captura */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }
        button:hover { background-color: #2ecc71; }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            width: 95%;
            max-width: 450px;
            font-size: 0.9em;
        }
        .error { background-color: #e74c3c; color: white; }
        .success { background-color: #2ecc71; color: white; }
        .info { background-color: #3498db; color: white; }
        
        #video-container {
            position: relative;
            width: 95%;
            max-width: 450px;
            padding-top: 70%; 
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        #canvas { display: none; } /* Canvas oculto para la captura */

        #result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 450px;
            text-align: left;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>Lector OCR de Documentos de Identidad</h1>
    
    <div id="status-message" class="message info">Cargando Tesseract.js...</div>

    <button id="cameraButton">Iniciar Cámara</button>
    <button id="captureButton" class="hidden" disabled>Capturar Documento y Leer (OCR)</button>

    <div id="video-container" class="hidden">
        <video id="video" playsinline></video>
    </div>
    
    <canvas id="canvas"></canvas>

    <div id="result-box" class="hidden">
        <h2>✅ Datos Extraídos</h2>
        <div class="data-item">
            <strong>Tipo de Documento:</strong> <span id="docType">N/A</span>
        </div>
        <div class="data-item">
            <strong>Número de Documento:</strong> <span id="docNumber">N/A</span>
        </div>
        <div class="data-item">
            <strong>Nombre Completo:</strong> <span id="fullName">N/A</span>
        </div>
        <hr>
        <p><strong>Texto OCR Crudo (para diagnóstico):</strong></p>
        <pre id="rawText"></pre>
    </div>

    <script src='https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js'></script>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraButton = document.getElementById('cameraButton');
        const captureButton = document.getElementById('captureButton');
        const videoContainer = document.getElementById('video-container');
        const statusMessage = document.getElementById('status-message');
        const resultBox = document.getElementById('result-box');
        const rawText = document.getElementById('rawText');
        const docTypeSpan = document.getElementById('docType');
        const docNumberSpan = document.getElementById('docNumber');
        const fullNameSpan = document.getElementById('fullName');

        // State Variables
        let currentStream = null;
        let isCameraActive = false;
        let worker = null;

        // --- Utilidades de Estado ---
        function setStatus(text, type = 'info') {
            statusMessage.textContent = text;
            statusMessage.className = `message ${type}`;
        }

        function toggleCameraView(show) {
            videoContainer.classList.toggle('hidden', !show);
            captureButton.classList.toggle('hidden', !show);
            resultBox.classList.add('hidden');
            cameraButton.textContent = show ? 'Detener Cámara' : 'Iniciar Cámara';
        }

        // --- Lógica de la Cámara ---

        async function startCamera() {
            if (isCameraActive) {
                stopCamera();
                return;
            }

            setStatus('Solicitando permiso de cámara...', 'info');
            
            try {
                // Preferir la cámara trasera para mejor calidad OCR
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { ideal: 'environment' } } 
                });
                
                video.srcObject = currentStream;
                await video.play();

                isCameraActive = true;
                toggleCameraView(true);
                captureButton.disabled = false;
                setStatus('Cámara activa. Alinee el documento y capture.', 'success');

            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                let message = '❌ Error al iniciar la cámara.';
                if (error.name === 'NotAllowedError') {
                    message = '⚠️ Permiso denegado. Habilita el acceso a la cámara en tu navegador.';
                } else if (error.name === 'NotFoundError') {
                    message = '⚠️ No se encontró cámara.';
                }
                setStatus(message, 'error');
                stopCamera();
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            video.srcObject = null;
            isCameraActive = false;
            captureButton.disabled = true;
            toggleCameraView(false);
            setStatus('Cámara detenida.', 'info');
        }

        // --- Lógica de Captura y OCR ---

        function captureImage() {
            if (!isCameraActive) return;

            // 1. Dibujar el frame actual del video en el canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 2. Detener la cámara mientras se procesa
            stopCamera();
            setStatus('Documento capturado. Iniciando OCR, esto puede tardar...', 'info');

            // 3. Ejecutar OCR
            runOCR(canvas);
        }

        async function runOCR(image) {
            try {
                // Mostrar el cuadro de resultados mientras procesa
                resultBox.classList.remove('hidden');
                docTypeSpan.textContent = 'Procesando...';
                docNumberSpan.textContent = 'Procesando...';
                fullNameSpan.textContent = 'Procesando...';
                rawText.textContent = 'Cargando datos...';
                
                // OCR: Reconocimiento de caracteres en español (spa)
                const { data: { text, progress } } = await worker.recognize(image);

                setStatus('✅ OCR Completado. Extrayendo datos.', 'success');
                
                // Mostrar texto crudo
                rawText.textContent = text;
                
                // Extraer los datos estructurados
                const extracted = extractDocumentData(text);
                
                // Mostrar resultados extraídos
                docTypeSpan.textContent = extracted.tipoDocumento;
                docNumberSpan.textContent = extracted.numeroDocumento;
                fullNameSpan.textContent = extracted.nombreCompleto;
                
            } catch (error) {
                console.error('Error durante el OCR:', error);
                setStatus('❌ Error grave de OCR. Inténtalo de nuevo.', 'error');
                rawText.textContent = `Error: ${error.message}`;
            }
        }


        // --- Lógica de Extracción de Datos (PARSING) ---

        /**
         * Implementación de la lógica de extracción basada en el texto reconocido (OCR).
         * @param {string} ocrText - Texto crudo reconocido por Tesseract.js.
         */
        function extractDocumentData(ocrText) {
            const defaultResult = {
                tipoDocumento: 'N/A',
                numeroDocumento: 'N/A',
                nombreCompleto: 'No se pudo encontrar el nombre/número.'
            };

            // Normalizar el texto (pasar a mayúsculas, quitar espacios extra)
            const normalizedText = ocrText.toUpperCase().replace(/\s+/g, ' ').trim();
            const lines = normalizedText.split('\n').map(line => line.trim()).filter(line => line.length > 3);

            let docType = 'N/A';
            let docNumber = 'N/A';
            let fullName = 'N/A';
            
            // 1. Identificar Tipo de Documento y Número
            
            // Regex para Cédula de Ciudadanía (CC) o Número Único de Identificación Personal (NUIP)
            // Busca la palabra NUMERO o NUIP seguida de 8-10 dígitos (o 10-12)
            // Ejemplo: NUMERO 6.845.256.666
            const ccRegex = /(?:CEDULA|NÚMERO|NUMERO|NUIP)\s*[\.:]*\s*(\d{1,3}[\.\s]\d{3}[\.\s]\d{3}[\.\s]\d{3}|\d{8,12})/i;
            const tiRegex = /(?:TARJETA|T\.I\.)\s*(?:NÚMERO|NUMERO)\s*[\.:]*\s*(\d{8,12})/i;
            const pepRegex = /(?:NO\.|PERMISO)\s*(\d{8,15})/i; // Permiso Especial de Permanencia o PPT

            for (const line of lines) {
                let match;

                // Cédula de Ciudadanía (CC)
                if (match = line.match(ccRegex)) {
                    docType = 'CC';
                    // Limpiar el número de puntos y espacios
                    docNumber = match[1].replace(/[\.\s]/g, '');
                    break; 
                }
                
                // Tarjeta de Identidad (TI)
                if (match = line.match(tiRegex)) {
                    docType = 'TI';
                    docNumber = match[1].replace(/[\.\s]/g, '');
                    break; 
                }

                 // Permiso por Protección Temporal (PPT) o similares (PEPx)
                if (match = line.match(pepRegex)) {
                    docType = 'PPT/PEP';
                    docNumber = match[1].replace(/[\.\s]/g, '');
                    break; 
                }
            }

            // 2. Identificar Nombre y Apellidos
            
            // Esto es la parte más difícil del OCR. Buscamos líneas que contengan las palabras clave.
            let apellidoLine = lines.find(l => l.includes('APELLIDO') || l.includes('APELLIDOS'));
            let nombreLine = lines.find(l => l.includes('NOMBRE') || l.includes('NOMBRES'));

            if (apellidoLine && nombreLine) {
                // Intentar extraer el texto que sigue a la palabra clave
                const cleanApellido = apellidoLine.replace(/(?:APELLIDOS|APELLIDO)\s*[\.:]*\s*/i, '').trim();
                const cleanNombre = nombreLine.replace(/(?:NOMBRES|NOMBRE)\s*[\.:]*\s*/i, '').trim();
                
                fullName = `${cleanNombre} ${cleanApellido}`.trim();
                
                // Si la extracción del nombre fue exitosa, actualizar el resultado
                if (fullName.length > 5 && fullName !== 'N/A') {
                     // Solo actualizar si encontramos algo que parezca un nombre
                     defaultResult.nombreCompleto = fullName;
                }
            }
            
            // Resultado final
            return {
                tipoDocumento: docType,
                numeroDocumento: docNumber,
                nombreCompleto: fullName.length > 5 ? fullName : defaultResult.nombreCompleto
            };
        }

        // --- Inicialización ---
        
        async function initializeTesseractWorker() {
            setStatus('Cargando núcleo de OCR (Tesseract.js)...', 'info');
             try {
                // Crear el worker de Tesseract (web worker para procesamiento en segundo plano)
                worker = await Tesseract.createWorker('spa'); // Usar español para documentos colombianos
                setStatus('Tesseract Worker cargado. Listo para iniciar cámara.', 'success');
                cameraButton.disabled = false;
            } catch (error) {
                setStatus('❌ Error: Falló la inicialización de Tesseract. Revisa la conexión.', 'error');
                console.error(error);
                cameraButton.disabled = true;
            }
        }
        
        cameraButton.addEventListener('click', startCamera);
        captureButton.addEventListener('click', captureImage);

        // Iniciar la carga del worker
        document.addEventListener('DOMContentLoaded', initializeTesseractWorker);
    </script>
</body>
</html>
