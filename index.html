<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de PDF417 (Cédula) - Súper Robusto V3</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            padding: 10px;
            margin: 0;
            text-align: center;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; }
        
        button {
            padding: 12px 25px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }
        button:hover { background-color: #3498db; }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            width: 95%;
            max-width: 400px;
            font-size: 0.9em;
        }
        .error { background-color: #e74c3c; color: white; }
        .success { background-color: #2ecc71; color: white; }
        .info { background-color: #f1c40f; color: #333; }
        
        #video-container {
            position: relative;
            width: 95%;
            max-width: 400px;
            padding-top: 75%; 
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        #scan-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 10;
            border: 3px dashed #f39c12; 
            width: 80%;
            height: 60%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 400px;
            text-align: left;
        }
        .data-item {
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .data-item strong { color: #34495e; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>Lector de Cédula (PDF417)</h1>
    
    <div id="status-message" class="message info">Cargando...</div>

    <button id="startButton">Iniciar Escaneo</button>

    <div id="video-container" class="hidden">
        <video id="video" playsinline></video>
        <div id="scan-feedback">Alinee el código PDF417</div>
    </div>

    <div id="result-box" class="hidden">
        <h2>✅ Datos Extraídos</h2>
        <div class="data-item">
            <strong>Texto Crudo:</strong> <span id="decodedText"></span>
        </div>
        <div class="data-item">
            <strong>Tipo de Documento:</strong> <span id="docType"></span>
        </div>
        <div class="data-item">
            <strong>Número de Documento:</strong> <span id="docNumber"></span>
        </div>
        <div class="data-item">
            <strong>Nombre Completo:</strong> <span id="fullName"></span>
        </div>
    </div>

    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

    <script>
        // Constantes de Elementos DOM
        const video = document.getElementById('video');
        const startButton = document.getElementById('startButton');
        const videoContainer = document.getElementById('video-container');
        const statusMessage = document.getElementById('status-message');
        const resultBox = document.getElementById('result-box');

        // Elementos de Resultado
        const decodedText = document.getElementById('decodedText');
        const docType = document.getElementById('docType');
        const docNumber = document.getElementById('docNumber');
        const fullName = document.getElementById('fullName');

        // Variables de estado
        let codeReader = null;
        let isScanning = false;
        let currentStream = null; // Para guardar la referencia del stream de la cámara

        // --- UTILIDADES ---
        function setStatus(text, type = 'info') {
            statusMessage.textContent = text;
            statusMessage.className = `message ${type}`;
        }
        
        function toggleScanning(show) {
            videoContainer.classList.toggle('hidden', !show);
            resultBox.classList.add('hidden');
            startButton.textContent = show ? 'Detener Escaneo' : 'Iniciar Escaneo';
        }

        // --- MANEJO DE PERMISOS E INICIALIZACIÓN ---

        function initializeReader() {
            if (typeof ZXing === 'undefined') {
                 setStatus('❌ Error: La librería ZXing no se cargó correctamente.', 'error');
                 startButton.disabled = true;
                 return;
            }

            try {
                // Configurar el lector para PDF417
                codeReader = new ZXing.BrowserCodeReader(null, { 
                    formats: [ZXing.BarcodeFormat.PDF_417],
                    videoConstraints: {
                         // Preferir la cámara trasera para mejor calidad
                         facingMode: { ideal: 'environment' }
                    }
                });
                setStatus('Lector inicializado. Pulsa "Iniciar Escaneo".', 'info');
                startButton.disabled = false;
            } catch (error) {
                setStatus('❌ Error: No se pudo inicializar la librería de decodificación.', 'error');
                console.error('Error de inicialización de ZXing:', error);
                startButton.disabled = true;
            }
        }

        /**
         * Solución al "Trying to play video that is already playing."
         * Detiene limpiamente el stream de video de la cámara.
         */
        function stopCameraStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (video.srcObject) {
                video.srcObject = null;
            }
        }
        
        function stopScanning() {
            if (!codeReader) return;
            
            // 1. Detener el proceso interno de ZXing
            codeReader.reset();
            // 2. Detener el stream de la cámara (Súper Importante)
            stopCameraStream(); 

            toggleScanning(false);
            isScanning = false;
        }

        /**
         * Función que solicita el acceso a la cámara y luego inicia el escaneo.
         */
        async function startScanning() {
            if (!codeReader) {
                setStatus('❌ El lector no está listo. Intenta recargar.', 'error');
                return;
            }
            if (isScanning) {
                console.log("Advertencia: El escaneo ya está activo.");
                return;
            }

            stopScanning(); // Asegurar que todo está limpio antes de empezar
            
            setStatus('Solicitando permiso de cámara...', 'info');
            toggleScanning(true);
            isScanning = true;

            try {
                // 1. Obtener el stream de la cámara manualmente (Para manejo de errores)
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { ideal: 'environment' } } 
                });
                
                // 2. Asignar el stream al elemento de video
                video.srcObject = currentStream;
                video.play();
                
                setStatus('Cámara activa. Buscando código PDF417...', 'info');

                // 3. Iniciar la decodificación usando el elemento de video
                // La llamada a decodeFromVideo continua en segundo plano
                codeReader.decodeFromVideo(video, (result, err) => {
                    if (!isScanning) return; 

                    if (result) {
                        setStatus('✅ Código PDF417 leído con éxito.', 'success');
                        const extracted = extractColombianData(result.text);
                        
                        decodedText.textContent = result.text;
                        docType.textContent = extracted.tipoDocumento;
                        docNumber.textContent = extracted.numeroDocumento;
                        fullName.textContent = extracted.nombreCompleto;
                        
                        resultBox.classList.remove('hidden');
                        stopScanning();
                    } else if (err && !(err instanceof ZXing.NotFoundException)) {
                         // Manejar errores de decodificación que no sean "No encontrado"
                        console.error('Error de lectura/decodificación:', err);
                        setStatus('❌ Error crítico de decodificación. Revisa la consola.', 'error');
                        stopScanning(); 
                    }
                });


            } catch (error) {
                // Manejo de errores de hardware y permisos
                console.error('Error al intentar acceder a la cámara:', error);
                if (error.name === 'NotAllowedError') {
                    setStatus('⚠️ Acceso a cámara denegado. Habilita los permisos en la configuración.', 'error');
                } else if (error.name === 'NotFoundError') {
                    setStatus('⚠️ No se encontró ninguna cámara disponible.', 'error');
                } else {
                    setStatus(`❌ Error al iniciar la cámara: ${error.message}`, 'error');
                }
                stopScanning();
            }
        }


        // --- LÓGICA DE PARSING (Extracción de campos) ---
        function extractColombianData(dataString) {
            const defaultResult = {
                tipoDocumento: 'N/A',
                numeroDocumento: 'N/A',
                nombreCompleto: 'No se pudo parsear (Formato desconocido)'
            };
            
            if (dataString && dataString.startsWith('@|')) {
                const parts = dataString.substring(2).split('|').map(p => p.trim());
                
                if (parts.length >= 6) {
                    const tipoDoc = parts[0]; 
                    const numDoc = parts[1]; 
                    const apellido1 = parts[2] || ''; 
                    const apellido2 = parts[3] || ''; 
                    const nombre1 = parts[4] || ''; 
                    const nombre2 = parts[5] || ''; 
                    
                    const nombreCompleto = `${nombre1} ${nombre2} ${apellido1} ${apellido2}`.trim();

                    return {
                        tipoDocumento: tipoDoc || 'N/A',
                        numeroDocumento: numDoc || 'N/A',
                        nombreCompleto: nombreCompleto || 'N/A'
                    };
                } else {
                    return { ...defaultResult, nombreCompleto: 'Error: Cadena incompleta o formato inesperado.' };
                }
            } 
            
            return defaultResult;
        }

        // --- MANEJADOR DE EVENTOS ---
        startButton.addEventListener('click', () => {
            if (isScanning) {
                stopScanning();
                setStatus('Escaneo detenido por el usuario.', 'info');
            } else {
                startScanning();
            }
        });

        // Inicializar el lector al cargar la página
        document.addEventListener('DOMContentLoaded', initializeReader);
    </script>
</body>
</html>
